<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Asynchronous distributed rate limiting for FastAPI/Starlette applications."><meta name=author content=tioluwa><link href=https://ti-oluwa.github.io/traffik/advanced/rules/ rel=canonical><link href=../headers/ rel=prev><link href=../registry/ rel=next><link rel=icon href=../../assets/logo.svg><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.7.1"><title>Throttle Rules & Wildcards - Traffik</title><link rel=stylesheet href=../../assets/stylesheets/main.484c7ddc.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.ab4e12ef.min.css><style>:root{--md-admonition-icon--note:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M1%207.775V2.75C1%201.784%201.784%201%202.75%201h5.025c.464%200%20.91.184%201.238.513l6.25%206.25a1.75%201.75%200%200%201%200%202.474l-5.026%205.026a1.75%201.75%200%200%201-2.474%200l-6.25-6.25A1.75%201.75%200%200%201%201%207.775m1.5%200c0%20.066.026.13.073.177l6.25%206.25a.25.25%200%200%200%20.354%200l5.025-5.025a.25.25%200%200%200%200-.354l-6.25-6.25a.25.25%200%200%200-.177-.073H2.75a.25.25%200%200%200-.25.25ZM6%205a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E');--md-admonition-icon--tip:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M3.499.75a.75.75%200%200%201%201.5%200v.996C5.9%202.903%206.793%203.65%207.662%204.376l.24.202c-.036-.694.055-1.422.426-2.163C9.1.873%2010.794-.045%2012.622.26%2014.408.558%2016%201.94%2016%204.25c0%201.278-.954%202.575-2.44%202.734l.146.508.065.22c.203.701.412%201.455.476%202.226.142%201.707-.4%203.03-1.487%203.898C11.714%2014.671%2010.27%2015%208.75%2015h-6a.75.75%200%200%201%200-1.5h1.376a4.5%204.5%200%200%201-.563-1.191%203.84%203.84%200%200%201-.05-2.063%204.65%204.65%200%200%201-2.025-.293.75.75%200%200%201%20.525-1.406c1.357.507%202.376-.006%202.698-.318l.009-.01a.747.747%200%200%201%201.06%200%20.75.75%200%200%201-.012%201.074c-.912.92-.992%201.835-.768%202.586.221.74.745%201.337%201.196%201.621H8.75c1.343%200%202.398-.296%203.074-.836.635-.507%201.036-1.31.928-2.602-.05-.603-.216-1.224-.422-1.93l-.064-.221c-.12-.407-.246-.84-.353-1.29a2.4%202.4%200%200%201-.507-.441%203.1%203.1%200%200%201-.633-1.248.75.75%200%200%201%201.455-.364c.046.185.144.436.31.627.146.168.353.305.712.305.738%200%201.25-.615%201.25-1.25%200-1.47-.95-2.315-2.123-2.51-1.172-.196-2.227.387-2.706%201.345-.46.92-.27%201.774.019%203.062l.042.19.01.05c.348.443.666.949.94%201.553a.75.75%200%201%201-1.365.62c-.553-1.217-1.32-1.94-2.3-2.768L6.7%205.527c-.814-.68-1.75-1.462-2.692-2.619a3.7%203.7%200%200%200-1.023.88c-.406.495-.663%201.036-.722%201.508.116.122.306.21.591.239.388.038.797-.06%201.032-.19a.75.75%200%200%201%20.728%201.31c-.515.287-1.23.439-1.906.373-.682-.067-1.473-.38-1.879-1.193L.75%205.677V5.5c0-.984.48-1.94%201.077-2.664.46-.559%201.05-1.055%201.673-1.353z%22/%3E%3C/svg%3E');--md-admonition-icon--warning:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M6.457%201.047c.659-1.234%202.427-1.234%203.086%200l6.082%2011.378A1.75%201.75%200%200%201%2014.082%2015H1.918a1.75%201.75%200%200%201-1.543-2.575Zm1.763.707a.25.25%200%200%200-.44%200L1.698%2013.132a.25.25%200%200%200%20.22.368h12.164a.25.25%200%200%200%20.22-.368Zm.53%203.996v2.5a.75.75%200%200%201-1.5%200v-2.5a.75.75%200%200%201%201.5%200M9%2011a1%201%200%201%201-2%200%201%201%200%200%201%202%200%22/%3E%3C/svg%3E');--md-admonition-icon--danger:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M9.504.43a1.516%201.516%200%200%201%202.437%201.713L10.415%205.5h2.123c1.57%200%202.346%201.909%201.22%203.004l-7.34%207.142a1.25%201.25%200%200%201-.871.354h-.302a1.25%201.25%200%200%201-1.157-1.723L5.633%2010.5H3.462c-1.57%200-2.346-1.909-1.22-3.004zm1.047%201.074L3.286%208.571A.25.25%200%200%200%203.462%209H6.75a.75.75%200%200%201%20.694%201.034l-1.713%204.188%206.982-6.793A.25.25%200%200%200%2012.538%207H9.25a.75.75%200%200%201-.683-1.06l2.008-4.418.003-.006-.004-.009-.006-.006-.008-.001q-.005%200-.009.004%22/%3E%3C/svg%3E');--md-admonition-icon--info:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M0%208a8%208%200%201%201%2016%200A8%208%200%200%201%200%208m8-6.5a6.5%206.5%200%201%200%200%2013%206.5%206.5%200%200%200%200-13M6.5%207.75A.75.75%200%200%201%207.25%207h1a.75.75%200%200%201%20.75.75v2.75h.25a.75.75%200%200%201%200%201.5h-2a.75.75%200%200%201%200-1.5h.25v-2h-.25a.75.75%200%200%201-.75-.75M8%206a1%201%200%201%201%200-2%201%201%200%200%201%200%202%22/%3E%3C/svg%3E');--md-admonition-icon--success:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M13.78%204.22a.75.75%200%200%201%200%201.06l-7.25%207.25a.75.75%200%200%201-1.06%200L2.22%209.28a.75.75%200%200%201%20.018-1.042.75.75%200%200%201%201.042-.018L6%2010.94l6.72-6.72a.75.75%200%200%201%201.06%200%22/%3E%3C/svg%3E');--md-admonition-icon--example:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5%205.782V2.5h-.25a.75.75%200%200%201%200-1.5h6.5a.75.75%200%200%201%200%201.5H11v3.282l3.666%205.76C15.619%2013.04%2014.543%2015%2012.767%2015H3.233c-1.776%200-2.852-1.96-1.899-3.458Zm-2.4%206.565a.75.75%200%200%200%20.633%201.153h9.534a.75.75%200%200%200%20.633-1.153L12.225%2010.5h-8.45ZM9.5%202.5h-3V6c0%20.143-.04.283-.117.403L4.73%209h6.54L9.617%206.403A.75.75%200%200%201%209.5%206Z%22/%3E%3C/svg%3E');}</style><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../assets/css/custom.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=slate data-md-color-primary=deep-orange data-md-color-accent=amber> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#throttle-rules-wildcards class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <div data-md-color-scheme=default data-md-component=outdated hidden> </div> <header class="md-header md-header--shadow md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title=Traffik class="md-header__button md-logo" aria-label=Traffik data-md-component=logo> <img src=../../assets/logo.svg alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Traffik </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Throttle Rules & Wildcards </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=deep-orange data-md-color-accent=amber aria-label="Switch to light mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=deep-orange data-md-color-accent=amber aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/ti-oluwa/traffik title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </div> <div class=md-source__repository> ti-oluwa/traffik </div> </a> </div> </nav> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../../installation/ class=md-tabs__link> Getting Started </a> </li> <li class=md-tabs__item> <a href=../../core-concepts/ class=md-tabs__link> Core Concepts </a> </li> <li class=md-tabs__item> <a href=../../integration/ class=md-tabs__link> Integration </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../ class=md-tabs__link> Advanced </a> </li> <li class=md-tabs__item> <a href=../../configuration/ class=md-tabs__link> Configuration </a> </li> <li class=md-tabs__item> <a href=../../error-handling/ class=md-tabs__link> Error Handling </a> </li> <li class=md-tabs__item> <a href=../../extending/strategies/ class=md-tabs__link> Extending Traffik </a> </li> <li class=md-tabs__item> <a href=../../testing/ class=md-tabs__link> Testing </a> </li> <li class=md-tabs__item> <a href=../../benchmarks/ class=md-tabs__link> Benchmarks </a> </li> <li class=md-tabs__item> <a href=../../performance/ class=md-tabs__link> Performance </a> </li> <li class=md-tabs__item> <a href=../../api-reference/ class=md-tabs__link> API Reference </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title=Traffik class="md-nav__button md-logo" aria-label=Traffik data-md-component=logo> <img src=../../assets/logo.svg alt=logo> </a> Traffik </label> <div class=md-nav__source> <a href=https://github.com/ti-oluwa/traffik title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </div> <div class=md-source__repository> ti-oluwa/traffik </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex=0> <span class=md-ellipsis> Getting Started </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Getting Started </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../installation/ class=md-nav__link> <span class=md-ellipsis> Installation </span> </a> </li> <li class=md-nav__item> <a href=../../quickstart/ class=md-nav__link> <span class=md-ellipsis> Quick Start </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex=0> <span class=md-ellipsis> Core Concepts </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Core Concepts </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../core-concepts/ class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=../../core-concepts/rates/ class=md-nav__link> <span class=md-ellipsis> Rate Format </span> </a> </li> <li class=md-nav__item> <a href=../../core-concepts/backends/ class=md-nav__link> <span class=md-ellipsis> Backends </span> </a> </li> <li class=md-nav__item> <a href=../../core-concepts/strategies/ class=md-nav__link> <span class=md-ellipsis> Strategies </span> </a> </li> <li class=md-nav__item> <a href=../../core-concepts/identifiers/ class=md-nav__link> <span class=md-ellipsis> Identifiers </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex=0> <span class=md-ellipsis> Integration </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Integration </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../integration/ class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=../../integration/dependencies/ class=md-nav__link> <span class=md-ellipsis> Dependencies </span> </a> </li> <li class=md-nav__item> <a href=../../integration/decorators/ class=md-nav__link> <span class=md-ellipsis> Decorators </span> </a> </li> <li class=md-nav__item> <a href=../../integration/middleware/ class=md-nav__link> <span class=md-ellipsis> Middleware </span> </a> </li> <li class=md-nav__item> <a href=../../integration/direct-usage/ class=md-nav__link> <span class=md-ellipsis> Direct Usage </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5 checked> <label class=md-nav__link for=__nav_5 id=__nav_5_label tabindex> <span class=md-ellipsis> Advanced </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=true> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Advanced </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../ class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=../headers/ class=md-nav__link> <span class=md-ellipsis> Response Headers </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> Throttle Rules & Wildcards </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> Throttle Rules & Wildcards </span> </a> <nav class="md-nav md-nav--secondary" aria-label="On this page"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> On this page </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#the-problem-selective-throttling class=md-nav__link> <span class=md-ellipsis> The Problem: Selective Throttling </span> </a> </li> <li class=md-nav__item> <a href=#throttlerule-only-apply-when class=md-nav__link> <span class=md-ellipsis> ThrottleRule: "Only apply when..." </span> </a> </li> <li class=md-nav__item> <a href=#bypassthrottlerule-skip-when class=md-nav__link> <span class=md-ellipsis> BypassThrottleRule: "Skip when..." </span> </a> </li> <li class=md-nav__item> <a href=#wildcard-path-patterns class=md-nav__link> <span class=md-ellipsis> Wildcard Path Patterns </span> </a> </li> <li class=md-nav__item> <a href=#attaching-rules-at-initialization class=md-nav__link> <span class=md-ellipsis> Attaching Rules at Initialization </span> </a> </li> <li class=md-nav__item> <a href=#adding-rules-after-initialization class=md-nav__link> <span class=md-ellipsis> Adding Rules After Initialization </span> </a> </li> <li class=md-nav__item> <a href=#custom-predicate-rules class=md-nav__link> <span class=md-ellipsis> Custom Predicate Rules </span> </a> </li> <li class=md-nav__item> <a href=#rule-evaluation-order class=md-nav__link> <span class=md-ellipsis> Rule Evaluation Order </span> </a> </li> <li class=md-nav__item> <a href=#the-throttleregistry-and-global_registry class=md-nav__link> <span class=md-ellipsis> The ThrottleRegistry and GLOBAL_REGISTRY </span> </a> </li> <li class=md-nav__item> <a href=#full-real-world-example class=md-nav__link> <span class=md-ellipsis> Full Real-World Example </span> </a> <nav class=md-nav aria-label="Full Real-World Example"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#what-happens-on-each-route class=md-nav__link> <span class=md-ellipsis> What happens on each route </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#choosing-the-right-tool class=md-nav__link> <span class=md-ellipsis> Choosing the Right Tool </span> </a> </li> <li class=md-nav__item> <a href=#summary class=md-nav__link> <span class=md-ellipsis> Summary </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../registry/ class=md-nav__link> <span class=md-ellipsis> Throttle Registry </span> </a> </li> <li class=md-nav__item> <a href=../request-costs/ class=md-nav__link> <span class=md-ellipsis> Request Costs </span> </a> </li> <li class=md-nav__item> <a href=../multiple-limits/ class=md-nav__link> <span class=md-ellipsis> Multiple Limits </span> </a> </li> <li class=md-nav__item> <a href=../exemptions/ class=md-nav__link> <span class=md-ellipsis> Exemptions </span> </a> </li> <li class=md-nav__item> <a href=../context-backends/ class=md-nav__link> <span class=md-ellipsis> Context-Aware Backends </span> </a> </li> <li class=md-nav__item> <a href=../statistics/ class=md-nav__link> <span class=md-ellipsis> Strategy Statistics </span> </a> </li> <li class=md-nav__item> <a href=../throttled-handlers/ class=md-nav__link> <span class=md-ellipsis> Custom Throttled Handlers </span> </a> </li> <li class=md-nav__item> <a href=../quota-context/ class=md-nav__link> <span class=md-ellipsis> Quota Context </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../configuration/ class=md-nav__link> <span class=md-ellipsis> Configuration </span> </a> </li> <li class=md-nav__item> <a href=../../error-handling/ class=md-nav__link> <span class=md-ellipsis> Error Handling </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_8> <label class=md-nav__link for=__nav_8 id=__nav_8_label tabindex=0> <span class=md-ellipsis> Extending Traffik </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_8_label aria-expanded=false> <label class=md-nav__title for=__nav_8> <span class="md-nav__icon md-icon"></span> Extending Traffik </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../extending/strategies/ class=md-nav__link> <span class=md-ellipsis> Custom Strategies </span> </a> </li> <li class=md-nav__item> <a href=../../extending/backends/ class=md-nav__link> <span class=md-ellipsis> Custom Backends </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../testing/ class=md-nav__link> <span class=md-ellipsis> Testing </span> </a> </li> <li class=md-nav__item> <a href=../../benchmarks/ class=md-nav__link> <span class=md-ellipsis> Benchmarks </span> </a> </li> <li class=md-nav__item> <a href=../../performance/ class=md-nav__link> <span class=md-ellipsis> Performance </span> </a> </li> <li class=md-nav__item> <a href=../../api-reference/ class=md-nav__link> <span class=md-ellipsis> API Reference </span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="On this page"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> On this page </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#the-problem-selective-throttling class=md-nav__link> <span class=md-ellipsis> The Problem: Selective Throttling </span> </a> </li> <li class=md-nav__item> <a href=#throttlerule-only-apply-when class=md-nav__link> <span class=md-ellipsis> ThrottleRule: "Only apply when..." </span> </a> </li> <li class=md-nav__item> <a href=#bypassthrottlerule-skip-when class=md-nav__link> <span class=md-ellipsis> BypassThrottleRule: "Skip when..." </span> </a> </li> <li class=md-nav__item> <a href=#wildcard-path-patterns class=md-nav__link> <span class=md-ellipsis> Wildcard Path Patterns </span> </a> </li> <li class=md-nav__item> <a href=#attaching-rules-at-initialization class=md-nav__link> <span class=md-ellipsis> Attaching Rules at Initialization </span> </a> </li> <li class=md-nav__item> <a href=#adding-rules-after-initialization class=md-nav__link> <span class=md-ellipsis> Adding Rules After Initialization </span> </a> </li> <li class=md-nav__item> <a href=#custom-predicate-rules class=md-nav__link> <span class=md-ellipsis> Custom Predicate Rules </span> </a> </li> <li class=md-nav__item> <a href=#rule-evaluation-order class=md-nav__link> <span class=md-ellipsis> Rule Evaluation Order </span> </a> </li> <li class=md-nav__item> <a href=#the-throttleregistry-and-global_registry class=md-nav__link> <span class=md-ellipsis> The ThrottleRegistry and GLOBAL_REGISTRY </span> </a> </li> <li class=md-nav__item> <a href=#full-real-world-example class=md-nav__link> <span class=md-ellipsis> Full Real-World Example </span> </a> <nav class=md-nav aria-label="Full Real-World Example"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#what-happens-on-each-route class=md-nav__link> <span class=md-ellipsis> What happens on each route </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#choosing-the-right-tool class=md-nav__link> <span class=md-ellipsis> Choosing the Right Tool </span> </a> </li> <li class=md-nav__item> <a href=#summary class=md-nav__link> <span class=md-ellipsis> Summary </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <nav class=md-path aria-label=Navigation> <ol class=md-path__list> <li class=md-path__item> <a href=../.. class=md-path__link> <span class=md-ellipsis> Home </span> </a> </li> <li class=md-path__item> <a href=../ class=md-path__link> <span class=md-ellipsis> Advanced </span> </a> </li> </ol> </nav> <article class="md-content__inner md-typeset"> <h1 id=throttle-rules-wildcards>Throttle Rules &amp; Wildcards<a class=headerlink href=#throttle-rules-wildcards title="Permanent link">&para;</a></h1> <p>Throttles apply globally by default. Attach one to a router and it runs on every request that hits that router, no questions asked. That's perfect for simple cases, but real APIs rarely have simple cases.</p> <p>What if your global API throttle should apply to <em>most</em> routes but not the health check? What if <code>GET /users</code> has its own stricter limit and shouldn't also drain the shared pool? What if you want one throttle to govern anonymous users and a totally different one for premium accounts?</p> <p>That's what <strong>throttle rules</strong> are for. Rules let a throttle ask "does this connection even apply to me?" before doing anything, before touching the backend, before computing the client identifier, before any of it. If the rule says no, the throttle steps aside cleanly.</p> <hr> <h2 id=the-problem-selective-throttling>The Problem: Selective Throttling<a class=headerlink href=#the-problem-selective-throttling title="Permanent link">&para;</a></h2> <p>Here's the scenario that rules are designed for. Imagine a versioned API:</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a>/api/v1                  (GET: 1000/min, POST: 300/min)
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a>  /api/v1/users          (GET: 500/min,  POST: unlimited)
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a>  /api/v1/organizations  (GET: unlimited, POST: 600/min)
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a>    /api/v1/organizations/{id}  (GET: 100/min additional limit)
</span></code></pre></div> <p>The global throttle covers everything under <code>/api/v1</code>. But:</p> <ul> <li><code>GET /api/v1/users</code> has its own 500/min limit, so it shouldn't <em>also</em> eat from the 1000/min global pool for GETs.</li> <li><code>POST /api/v1/organizations</code> has its own 600/min limit, so it shouldn't <em>also</em> count against the global 300/min POST limit.</li> </ul> <p>Without rules, you'd have to manually split your routing, duplicate logic, or accept over-counting. With rules, you express exactly this in a few lines.</p> <hr> <h2 id=throttlerule-only-apply-when><code>ThrottleRule</code>: "Only apply when..."<a class=headerlink href=#throttlerule-only-apply-when title="Permanent link">&para;</a></h2> <p>A <code>ThrottleRule</code> is a gate: the throttle applies <strong>only</strong> when the connection matches the rule. Non-matching connections pass straight through without consuming any quota.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=kn>from</span><span class=w> </span><span class=nn>traffik.registry</span><span class=w> </span><span class=kn>import</span> <span class=n>ThrottleRule</span>
</span><span id=__span-1-2><a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a>
</span><span id=__span-1-3><a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a><span class=c1># Only throttle GET requests to /api/users</span>
</span><span id=__span-1-4><a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a><span class=n>rule</span> <span class=o>=</span> <span class=n>ThrottleRule</span><span class=p>(</span><span class=n>path</span><span class=o>=</span><span class=s2>&quot;/api/users&quot;</span><span class=p>,</span> <span class=n>methods</span><span class=o>=</span><span class=p>{</span><span class=s2>&quot;GET&quot;</span><span class=p>})</span>
</span><span id=__span-1-5><a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a><span class=n>throttle</span> <span class=o>=</span> <span class=n>HTTPThrottle</span><span class=p>(</span><span class=s2>&quot;api:users&quot;</span><span class=p>,</span> <span class=n>rate</span><span class=o>=</span><span class=s2>&quot;500/min&quot;</span><span class=p>,</span> <span class=n>rules</span><span class=o>=</span><span class=p>{</span><span class=n>rule</span><span class=p>})</span>
</span></code></pre></div> <p>A <code>ThrottleRule</code> accepts three optional parameters, all are conjunctive:</p> <ul> <li><strong><code>path</code></strong> - a path pattern (string, glob, or compiled regex). The connection's path must match.</li> <li><strong><code>methods</code></strong> - a set of HTTP method strings (e.g. <code>{"GET", "POST"}</code>). The connection's method must be in the set. Case-insensitive.</li> <li><strong><code>predicate</code></strong> - an async callable for custom logic. Must return <code>True</code> for the throttle to apply.</li> </ul> <p>If <em>any</em> of the specified criteria don't match, the throttle is skipped for that connection. All criteria that <em>are</em> specified must pass.</p> <hr> <h2 id=bypassthrottlerule-skip-when><code>BypassThrottleRule</code>: "Skip when..."<a class=headerlink href=#bypassthrottlerule-skip-when title="Permanent link">&para;</a></h2> <p><code>BypassThrottleRule</code> is the inverse: the throttle is skipped <strong>when</strong> the connection matches.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=kn>from</span><span class=w> </span><span class=nn>traffik.registry</span><span class=w> </span><span class=kn>import</span> <span class=n>BypassThrottleRule</span>
</span><span id=__span-2-2><a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a>
</span><span id=__span-2-3><a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a><span class=c1># Global throttle applies to everything EXCEPT GET /api/users</span>
</span><span id=__span-2-4><a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a><span class=n>bypass</span> <span class=o>=</span> <span class=n>BypassThrottleRule</span><span class=p>(</span><span class=n>path</span><span class=o>=</span><span class=s2>&quot;/api/users&quot;</span><span class=p>,</span> <span class=n>methods</span><span class=o>=</span><span class=p>{</span><span class=s2>&quot;GET&quot;</span><span class=p>})</span>
</span><span id=__span-2-5><a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a><span class=n>global_throttle</span> <span class=o>=</span> <span class=n>HTTPThrottle</span><span class=p>(</span><span class=s2>&quot;api:global&quot;</span><span class=p>,</span> <span class=n>rate</span><span class=o>=</span><span class=s2>&quot;1000/min&quot;</span><span class=p>,</span> <span class=n>rules</span><span class=o>=</span><span class=p>{</span><span class=n>bypass</span><span class=p>})</span>
</span></code></pre></div> <p>This is often more ergonomic for global throttles with carve-outs. Rather than listing every path that <em>should</em> be throttled (which changes as you add routes), you list the exceptions.</p> <div class="admonition tip"> <p class=admonition-title><code>ThrottleRule</code> vs <code>BypassThrottleRule</code>: which to reach for?</p> <p>Use <code>ThrottleRule</code> when you're building a <em>targeted</em> throttle that should only apply to specific routes, e.g., a strict limit on the login endpoint.</p> <p>Use <code>BypassThrottleRule</code> when you have a <em>broad</em> throttle (e.g., a global router-level limit) and want to carve out exceptions, e.g., "everything except health checks and the CDN callback."</p> </div> <hr> <h2 id=wildcard-path-patterns>Wildcard Path Patterns<a class=headerlink href=#wildcard-path-patterns title="Permanent link">&para;</a></h2> <p>The <code>path</code> parameter on both rule types accepts glob-style wildcards:</p> <table> <thead> <tr> <th>Pattern</th> <th>Matches</th> <th>Does not match</th> </tr> </thead> <tbody> <tr> <td><code>/api/*</code></td> <td><code>/api/users</code>, <code>/api/v1</code></td> <td><code>/api/v1/users</code> (contains nested <code>/</code>)</td> </tr> <tr> <td><code>/api/**</code></td> <td><code>/api/users</code>, <code>/api/v1/users</code>, <code>/api/a/b/c</code></td> <td><code>/other/path</code></td> </tr> <tr> <td><code>/api/v*/users</code></td> <td><code>/api/v1/users</code>, <code>/api/v2/users</code></td> <td><code>/api/v1/admins</code></td> </tr> <tr> <td><code>/api/users</code></td> <td><code>/api/users</code>, <code>/api/users/dashboard</code></td> <td><code>/other/users</code></td> </tr> </tbody> </table> <p>The rules are:</p> <ul> <li><strong><code>*</code></strong> matches a single path segment, everything except <code>/</code>. Useful for matching one level of path hierarchy.</li> <li><strong><code>**</code></strong> matches multiple segments including <code>/</code>. Useful for "everything under this prefix".</li> <li><strong>Plain strings</strong> (no <code>*</code>) are treated as prefix regex matches, so <code>/api/users</code> matches <code>/api/users</code>, <code>/api/users/123</code>, <code>/api/users/dashboard</code>, etc.</li> <li><strong>Compiled <code>re.Pattern</code></strong> objects are matched as-is against the full connection path.</li> </ul> <div class="language-python highlight"><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=kn>import</span><span class=w> </span><span class=nn>re</span>
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a><span class=kn>from</span><span class=w> </span><span class=nn>traffik.registry</span><span class=w> </span><span class=kn>import</span> <span class=n>BypassThrottleRule</span><span class=p>,</span> <span class=n>ThrottleRule</span>
</span><span id=__span-3-3><a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a>
</span><span id=__span-3-4><a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a><span class=c1># Glob wildcards</span>
</span><span id=__span-3-5><a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a><span class=n>BypassThrottleRule</span><span class=p>(</span><span class=n>path</span><span class=o>=</span><span class=s2>&quot;/api/v*/users&quot;</span><span class=p>)</span>    <span class=c1># /api/v1/users, /api/v2/users, etc.</span>
</span><span id=__span-3-6><a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a><span class=n>BypassThrottleRule</span><span class=p>(</span><span class=n>path</span><span class=o>=</span><span class=s2>&quot;/api/**&quot;</span><span class=p>)</span>           <span class=c1># Anything under /api/</span>
</span><span id=__span-3-7><a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a>
</span><span id=__span-3-8><a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a><span class=c1># Compiled regex (exact control)</span>
</span><span id=__span-3-9><a id=__codelineno-3-9 name=__codelineno-3-9 href=#__codelineno-3-9></a><span class=n>ThrottleRule</span><span class=p>(</span><span class=n>path</span><span class=o>=</span><span class=n>re</span><span class=o>.</span><span class=n>compile</span><span class=p>(</span><span class=sa>r</span><span class=s2>&quot;^/api/users/\d+$&quot;</span><span class=p>))</span>  <span class=c1># Only numeric user IDs</span>
</span><span id=__span-3-10><a id=__codelineno-3-10 name=__codelineno-3-10 href=#__codelineno-3-10></a>
</span><span id=__span-3-11><a id=__codelineno-3-11 name=__codelineno-3-11 href=#__codelineno-3-11></a><span class=c1># Prefix match (no wildcards)</span>
</span><span id=__span-3-12><a id=__codelineno-3-12 name=__codelineno-3-12 href=#__codelineno-3-12></a><span class=n>BypassThrottleRule</span><span class=p>(</span><span class=n>path</span><span class=o>=</span><span class=s2>&quot;/api/internal&quot;</span><span class=p>)</span>  <span class=c1># /api/internal, /api/internal/health, etc.</span>
</span></code></pre></div> <div class="admonition note"> <p class=admonition-title>Regex vs prefix matching</p> <p>When you pass a plain string with no <code>*</code>, Traffik compiles it as a regex and uses <code>re.Pattern.match()</code>, which matches from the start of the string. Since <code>match()</code> doesn't require matching to the end, <code>/api/users</code> becomes a prefix match. If you need a full-string match, use a compiled regex with <code>$</code> at the end.</p> </div> <div class="admonition tip"> <p class=admonition-title><code>ThrottleMiddleware</code> path uses <code>ThrottleRule</code> internally</p> <p>The <code>path</code> parameter on <code>MiddlewareThrottle</code> (used with <code>ThrottleMiddleware</code>) uses the same <code>ThrottleRule</code> path-matching logic internally. That means it supports the same wildcard patterns: <code>*</code>, <code>**</code>, plain string prefix match, and compiled <code>re.Pattern</code>. See <a href=../../integration/middleware/ >Middleware</a> for usage examples.</p> </div> <hr> <h2 id=attaching-rules-at-initialization>Attaching Rules at Initialization<a class=headerlink href=#attaching-rules-at-initialization title="Permanent link">&para;</a></h2> <p>Pass a <code>rules</code> set when constructing the throttle:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=kn>from</span><span class=w> </span><span class=nn>traffik</span><span class=w> </span><span class=kn>import</span> <span class=n>HTTPThrottle</span>
</span><span id=__span-4-2><a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a><span class=kn>from</span><span class=w> </span><span class=nn>traffik.registry</span><span class=w> </span><span class=kn>import</span> <span class=n>BypassThrottleRule</span>
</span><span id=__span-4-3><a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a>
</span><span id=__span-4-4><a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a><span class=n>bypass1</span> <span class=o>=</span> <span class=n>BypassThrottleRule</span><span class=p>(</span><span class=n>path</span><span class=o>=</span><span class=s2>&quot;/api/users&quot;</span><span class=p>,</span> <span class=n>methods</span><span class=o>=</span><span class=p>{</span><span class=s2>&quot;GET&quot;</span><span class=p>})</span>
</span><span id=__span-4-5><a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a><span class=n>bypass2</span> <span class=o>=</span> <span class=n>BypassThrottleRule</span><span class=p>(</span><span class=n>path</span><span class=o>=</span><span class=s2>&quot;/api/organizations&quot;</span><span class=p>,</span> <span class=n>methods</span><span class=o>=</span><span class=p>{</span><span class=s2>&quot;POST&quot;</span><span class=p>})</span>
</span><span id=__span-4-6><a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a>
</span><span id=__span-4-7><a id=__codelineno-4-7 name=__codelineno-4-7 href=#__codelineno-4-7></a><span class=n>global_throttle</span> <span class=o>=</span> <span class=n>HTTPThrottle</span><span class=p>(</span>
</span><span id=__span-4-8><a id=__codelineno-4-8 name=__codelineno-4-8 href=#__codelineno-4-8></a>    <span class=s2>&quot;api:v1&quot;</span><span class=p>,</span>
</span><span id=__span-4-9><a id=__codelineno-4-9 name=__codelineno-4-9 href=#__codelineno-4-9></a>    <span class=n>rate</span><span class=o>=</span><span class=s2>&quot;1000/min&quot;</span><span class=p>,</span>
</span><span id=__span-4-10><a id=__codelineno-4-10 name=__codelineno-4-10 href=#__codelineno-4-10></a>    <span class=n>rules</span><span class=o>=</span><span class=p>{</span><span class=n>bypass1</span><span class=p>,</span> <span class=n>bypass2</span><span class=p>},</span>  <span class=c1># Both bypass rules are attached at creation</span>
</span><span id=__span-4-11><a id=__codelineno-4-11 name=__codelineno-4-11 href=#__codelineno-4-11></a><span class=p>)</span>
</span></code></pre></div> <p>Rules passed here are attached directly to this throttle. They're deduplicated and sorted for optimal evaluation order automatically.</p> <hr> <h2 id=adding-rules-after-initialization>Adding Rules After Initialization<a class=headerlink href=#adding-rules-after-initialization title="Permanent link">&para;</a></h2> <p>You can also attach rules to <em>any</em> registered throttle by its UID after the fact, using <code>add_rules()</code> on any throttle instance:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=kn>from</span><span class=w> </span><span class=nn>traffik</span><span class=w> </span><span class=kn>import</span> <span class=n>HTTPThrottle</span>
</span><span id=__span-5-2><a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a><span class=kn>from</span><span class=w> </span><span class=nn>traffik.registry</span><span class=w> </span><span class=kn>import</span> <span class=n>BypassThrottleRule</span>
</span><span id=__span-5-3><a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a>
</span><span id=__span-5-4><a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a><span class=n>global_throttle</span> <span class=o>=</span> <span class=n>HTTPThrottle</span><span class=p>(</span><span class=s2>&quot;api:v1&quot;</span><span class=p>,</span> <span class=n>rate</span><span class=o>=</span><span class=s2>&quot;1000/min&quot;</span><span class=p>)</span>
</span><span id=__span-5-5><a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a>
</span><span id=__span-5-6><a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a><span class=c1># Later, when setting up the users router:</span>
</span><span id=__span-5-7><a id=__codelineno-5-7 name=__codelineno-5-7 href=#__codelineno-5-7></a><span class=n>users_throttle</span> <span class=o>=</span> <span class=n>HTTPThrottle</span><span class=p>(</span><span class=s2>&quot;api:users&quot;</span><span class=p>,</span> <span class=n>rate</span><span class=o>=</span><span class=s2>&quot;500/min&quot;</span><span class=p>)</span>
</span><span id=__span-5-8><a id=__codelineno-5-8 name=__codelineno-5-8 href=#__codelineno-5-8></a>
</span><span id=__span-5-9><a id=__codelineno-5-9 name=__codelineno-5-9 href=#__codelineno-5-9></a><span class=n>bypass_GET_users</span> <span class=o>=</span> <span class=n>BypassThrottleRule</span><span class=p>(</span><span class=n>path</span><span class=o>=</span><span class=s2>&quot;/api/v1/users&quot;</span><span class=p>,</span> <span class=n>methods</span><span class=o>=</span><span class=p>{</span><span class=s2>&quot;GET&quot;</span><span class=p>})</span>
</span><span id=__span-5-10><a id=__codelineno-5-10 name=__codelineno-5-10 href=#__codelineno-5-10></a><span class=n>users_throttle</span><span class=o>.</span><span class=n>add_rules</span><span class=p>(</span><span class=s2>&quot;api:v1&quot;</span><span class=p>,</span> <span class=n>bypass_GET_users</span><span class=p>)</span>
</span><span id=__span-5-11><a id=__codelineno-5-11 name=__codelineno-5-11 href=#__codelineno-5-11></a><span class=c1># ^ Attaches the rule to global_throttle (uid=&quot;api:v1&quot;), not to users_throttle</span>
</span></code></pre></div> <p>Notice the <code>add_rules</code> call: the first argument is the <strong>target throttle's UID</strong>, the throttle you want to <em>modify</em>. The rule is added to the global registry, and the target throttle will pick it up on its next <code>hit()</code> call.</p> <div class="admonition warning"> <p class=admonition-title>UIDs must be registered first</p> <p><code>add_rules("api:v1", ...)</code> will raise a <code>ConfigurationError</code> if no throttle with UID <code>"api:v1"</code> has been created yet. Create throttles before attaching rules to them.</p> </div> <p>By default, rules added via <code>add_rules()</code> are picked up on the first request after they're added and cached for efficiency. If you need rules to be re-fetched on every single request (rare), set <code>dynamic_rules=True</code> on the throttle.</p> <hr> <h2 id=custom-predicate-rules>Custom Predicate Rules<a class=headerlink href=#custom-predicate-rules title="Permanent link">&para;</a></h2> <p>For conditions that path and methods can't express, such as "only throttle premium users" or "skip throttling for internal service calls", use a <code>predicate</code>:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-6-1><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class=kn>from</span><span class=w> </span><span class=nn>traffik.registry</span><span class=w> </span><span class=kn>import</span> <span class=n>ThrottleRule</span><span class=p>,</span> <span class=n>BypassThrottleRule</span>
</span><span id=__span-6-2><a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a>
</span><span id=__span-6-3><a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a><span class=c1># Only apply this throttle to users on the &quot;premium&quot; tier</span>
</span><span id=__span-6-4><a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>only_premium</span><span class=p>(</span><span class=n>connection</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span><span id=__span-6-5><a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a>    <span class=n>user</span> <span class=o>=</span> <span class=nb>getattr</span><span class=p>(</span><span class=n>connection</span><span class=o>.</span><span class=n>state</span><span class=p>,</span> <span class=s2>&quot;user&quot;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
</span><span id=__span-6-6><a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a>    <span class=k>if</span> <span class=n>user</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span><span id=__span-6-7><a id=__codelineno-6-7 name=__codelineno-6-7 href=#__codelineno-6-7></a>        <span class=k>return</span> <span class=kc>False</span>
</span><span id=__span-6-8><a id=__codelineno-6-8 name=__codelineno-6-8 href=#__codelineno-6-8></a>    <span class=k>return</span> <span class=n>user</span><span class=o>.</span><span class=n>tier</span> <span class=o>==</span> <span class=s2>&quot;premium&quot;</span>
</span><span id=__span-6-9><a id=__codelineno-6-9 name=__codelineno-6-9 href=#__codelineno-6-9></a>
</span><span id=__span-6-10><a id=__codelineno-6-10 name=__codelineno-6-10 href=#__codelineno-6-10></a><span class=n>premium_rule</span> <span class=o>=</span> <span class=n>ThrottleRule</span><span class=p>(</span><span class=n>predicate</span><span class=o>=</span><span class=n>only_premium</span><span class=p>)</span>
</span><span id=__span-6-11><a id=__codelineno-6-11 name=__codelineno-6-11 href=#__codelineno-6-11></a><span class=n>premium_throttle</span> <span class=o>=</span> <span class=n>HTTPThrottle</span><span class=p>(</span><span class=s2>&quot;api:premium&quot;</span><span class=p>,</span> <span class=n>rate</span><span class=o>=</span><span class=s2>&quot;5000/min&quot;</span><span class=p>,</span> <span class=n>rules</span><span class=o>=</span><span class=p>{</span><span class=n>premium_rule</span><span class=p>})</span>
</span></code></pre></div> <p>Predicates can optionally accept a <code>context</code> argument:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-7-1><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>only_premium_with_context</span><span class=p>(</span><span class=n>connection</span><span class=p>,</span> <span class=n>context</span><span class=o>=</span><span class=kc>None</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span><span id=__span-7-2><a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a>    <span class=c1># context contains the throttle&#39;s merged context dict</span>
</span><span id=__span-7-3><a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a>    <span class=n>tier</span> <span class=o>=</span> <span class=p>(</span><span class=n>context</span> <span class=ow>or</span> <span class=p>{})</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;user_tier&quot;</span><span class=p>)</span>
</span><span id=__span-7-4><a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a>    <span class=k>return</span> <span class=n>tier</span> <span class=o>==</span> <span class=s2>&quot;premium&quot;</span>
</span></code></pre></div> <p>Traffik inspects the predicate's signature and passes <code>context</code> only if the function accepts it.</p> <hr> <h2 id=rule-evaluation-order>Rule Evaluation Order<a class=headerlink href=#rule-evaluation-order title="Permanent link">&para;</a></h2> <p>Rules are evaluated in an order optimised for short-circuit performance. Traffik automatically sorts them:</p> <ol> <li><strong><code>BypassThrottleRule</code> without predicate</strong> - fastest path; a frozenset lookup + regex match. Returns <code>False</code> on match (throttle skipped immediately).</li> <li><strong><code>ThrottleRule</code> without predicate</strong> - same cost as above. Returns <code>False</code> on non-match (throttle skipped immediately).</li> <li><strong><code>BypassThrottleRule</code> with predicate</strong> - async; predicate runs after path/method check passes.</li> <li><strong><code>ThrottleRule</code> with predicate</strong> - async; slowest. Runs only if all cheaper rules passed.</li> </ol> <p>You don't need to think about this ordering, Traffik handles it. But it's good to know why <strong>cheap method/path rules should always be preferred over predicates</strong> when they can express the same condition.</p> <div class="admonition note"> <p class=admonition-title><code>BypassThrottleRule</code> always wins first</p> <p><code>BypassThrottleRule</code> instances are always checked <strong>before</strong> <code>ThrottleRule</code> instances within the same priority tier. This short-circuit means: if any bypass rule matches, the throttle is skipped immediately without evaluating any <code>ThrottleRule</code> predicates. Keep bypass rules cheap and tight, they protect everything downstream.</p> </div> <hr> <h2 id=the-throttleregistry-and-global_registry>The <code>ThrottleRegistry</code> and <code>GLOBAL_REGISTRY</code><a class=headerlink href=#the-throttleregistry-and-global_registry title="Permanent link">&para;</a></h2> <p>Every throttle registers itself in the <code>GLOBAL_REGISTRY</code>, an instance of <code>ThrottleRegistry</code>, on construction (unless you pass a custom <code>registry</code>). This is what makes <code>add_rules()</code> work across module boundaries without passing references around.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-8-1><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a><span class=kn>from</span><span class=w> </span><span class=nn>traffik</span><span class=w> </span><span class=kn>import</span> <span class=n>HTTPThrottle</span>
</span><span id=__span-8-2><a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a><span class=kn>from</span><span class=w> </span><span class=nn>traffik.registry</span><span class=w> </span><span class=kn>import</span> <span class=n>GLOBAL_REGISTRY</span><span class=p>,</span> <span class=n>ThrottleRegistry</span>
</span><span id=__span-8-3><a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a>
</span><span id=__span-8-4><a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a><span class=c1># Check if a throttle has been registered</span>
</span><span id=__span-8-5><a id=__codelineno-8-5 name=__codelineno-8-5 href=#__codelineno-8-5></a><span class=n>GLOBAL_REGISTRY</span><span class=o>.</span><span class=n>exist</span><span class=p>(</span><span class=s2>&quot;api:v1&quot;</span><span class=p>)</span>   <span class=c1># True if HTTPThrottle(&quot;api:v1&quot;, ...) was called</span>
</span><span id=__span-8-6><a id=__codelineno-8-6 name=__codelineno-8-6 href=#__codelineno-8-6></a><span class=n>GLOBAL_REGISTRY</span><span class=o>.</span><span class=n>exist</span><span class=p>(</span><span class=s2>&quot;api:v99&quot;</span><span class=p>)</span>  <span class=c1># False</span>
</span><span id=__span-8-7><a id=__codelineno-8-7 name=__codelineno-8-7 href=#__codelineno-8-7></a>
</span><span id=__span-8-8><a id=__codelineno-8-8 name=__codelineno-8-8 href=#__codelineno-8-8></a><span class=c1># Add rules directly through the registry</span>
</span><span id=__span-8-9><a id=__codelineno-8-9 name=__codelineno-8-9 href=#__codelineno-8-9></a><span class=n>GLOBAL_REGISTRY</span><span class=o>.</span><span class=n>add_rules</span><span class=p>(</span><span class=s2>&quot;api:v1&quot;</span><span class=p>,</span> <span class=n>bypass_rule</span><span class=p>)</span>
</span><span id=__span-8-10><a id=__codelineno-8-10 name=__codelineno-8-10 href=#__codelineno-8-10></a>
</span><span id=__span-8-11><a id=__codelineno-8-11 name=__codelineno-8-11 href=#__codelineno-8-11></a><span class=c1># You can also create isolated registries for testing or multi-tenant setups</span>
</span><span id=__span-8-12><a id=__codelineno-8-12 name=__codelineno-8-12 href=#__codelineno-8-12></a><span class=n>custom_registry</span> <span class=o>=</span> <span class=n>ThrottleRegistry</span><span class=p>()</span>
</span><span id=__span-8-13><a id=__codelineno-8-13 name=__codelineno-8-13 href=#__codelineno-8-13></a><span class=n>throttle</span> <span class=o>=</span> <span class=n>HTTPThrottle</span><span class=p>(</span><span class=s2>&quot;api:v1&quot;</span><span class=p>,</span> <span class=n>rate</span><span class=o>=</span><span class=s2>&quot;100/min&quot;</span><span class=p>,</span> <span class=n>registry</span><span class=o>=</span><span class=n>custom_registry</span><span class=p>)</span>
</span></code></pre></div> <p>The registry uses a re-entrant lock internally, so it's safe to register throttles and add rules from different threads during application startup.</p> <div class="admonition note"> <p class=admonition-title>UID uniqueness</p> <p>Throttle UIDs must be globally unique within a registry. If you try to create two <code>HTTPThrottle</code> instances with the same UID, the second one raises a <code>ConfigurationError</code>. This is intentional, shared UIDs would cause state collisions in the backend.</p> </div> <hr> <h2 id=full-real-world-example>Full Real-World Example<a class=headerlink href=#full-real-world-example title="Permanent link">&para;</a></h2> <p>Here's the complete pattern for a versioned API with a global throttle and per-router carve-outs:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-9-1><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a><span class=kn>import</span><span class=w> </span><span class=nn>typing</span>
</span><span id=__span-9-2><a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a><span class=kn>from</span><span class=w> </span><span class=nn>fastapi</span><span class=w> </span><span class=kn>import</span> <span class=n>APIRouter</span><span class=p>,</span> <span class=n>Depends</span><span class=p>,</span> <span class=n>FastAPI</span><span class=p>,</span> <span class=n>Request</span>
</span><span id=__span-9-3><a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a>
</span><span id=__span-9-4><a id=__codelineno-9-4 name=__codelineno-9-4 href=#__codelineno-9-4></a><span class=kn>from</span><span class=w> </span><span class=nn>traffik</span><span class=w> </span><span class=kn>import</span> <span class=n>HTTPThrottle</span><span class=p>,</span> <span class=n>Rate</span>
</span><span id=__span-9-5><a id=__codelineno-9-5 name=__codelineno-9-5 href=#__codelineno-9-5></a><span class=kn>from</span><span class=w> </span><span class=nn>traffik.backends.inmemory</span><span class=w> </span><span class=kn>import</span> <span class=n>InMemoryBackend</span>
</span><span id=__span-9-6><a id=__codelineno-9-6 name=__codelineno-9-6 href=#__codelineno-9-6></a><span class=kn>from</span><span class=w> </span><span class=nn>traffik.decorators</span><span class=w> </span><span class=kn>import</span> <span class=n>throttled</span>
</span><span id=__span-9-7><a id=__codelineno-9-7 name=__codelineno-9-7 href=#__codelineno-9-7></a><span class=kn>from</span><span class=w> </span><span class=nn>traffik.registry</span><span class=w> </span><span class=kn>import</span> <span class=n>BypassThrottleRule</span>
</span><span id=__span-9-8><a id=__codelineno-9-8 name=__codelineno-9-8 href=#__codelineno-9-8></a>
</span><span id=__span-9-9><a id=__codelineno-9-9 name=__codelineno-9-9 href=#__codelineno-9-9></a><span class=n>app</span> <span class=o>=</span> <span class=n>FastAPI</span><span class=p>(</span><span class=n>lifespan</span><span class=o>=</span><span class=n>InMemoryBackend</span><span class=p>()</span><span class=o>.</span><span class=n>lifespan</span><span class=p>)</span>
</span><span id=__span-9-10><a id=__codelineno-9-10 name=__codelineno-9-10 href=#__codelineno-9-10></a>
</span><span id=__span-9-11><a id=__codelineno-9-11 name=__codelineno-9-11 href=#__codelineno-9-11></a><span class=c1># GLOBAL THROTTLE</span>
</span><span id=__span-9-12><a id=__codelineno-9-12 name=__codelineno-9-12 href=#__codelineno-9-12></a><span class=c1># GET: 1000/min, POST: 300/min for everything under /api/v1</span>
</span><span id=__span-9-13><a id=__codelineno-9-13 name=__codelineno-9-13 href=#__codelineno-9-13></a><span class=c1># Exceptions are carved out below with BypassThrottleRules.</span>
</span><span id=__span-9-14><a id=__codelineno-9-14 name=__codelineno-9-14 href=#__codelineno-9-14></a>
</span><span id=__span-9-15><a id=__codelineno-9-15 name=__codelineno-9-15 href=#__codelineno-9-15></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>global_rate</span><span class=p>(</span>
</span><span id=__span-9-16><a id=__codelineno-9-16 name=__codelineno-9-16 href=#__codelineno-9-16></a>    <span class=n>connection</span><span class=p>:</span> <span class=n>Request</span><span class=p>,</span>
</span><span id=__span-9-17><a id=__codelineno-9-17 name=__codelineno-9-17 href=#__codelineno-9-17></a>    <span class=n>context</span><span class=p>:</span> <span class=n>typing</span><span class=o>.</span><span class=n>Optional</span><span class=p>[</span><span class=n>typing</span><span class=o>.</span><span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>typing</span><span class=o>.</span><span class=n>Any</span><span class=p>]],</span>
</span><span id=__span-9-18><a id=__codelineno-9-18 name=__codelineno-9-18 href=#__codelineno-9-18></a><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Rate</span><span class=p>:</span>
</span><span id=__span-9-19><a id=__codelineno-9-19 name=__codelineno-9-19 href=#__codelineno-9-19></a>    <span class=k>if</span> <span class=n>connection</span><span class=o>.</span><span class=n>scope</span><span class=p>[</span><span class=s2>&quot;method&quot;</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&quot;GET&quot;</span><span class=p>:</span>
</span><span id=__span-9-20><a id=__codelineno-9-20 name=__codelineno-9-20 href=#__codelineno-9-20></a>        <span class=k>return</span> <span class=n>Rate</span><span class=o>.</span><span class=n>parse</span><span class=p>(</span><span class=s2>&quot;1000/min&quot;</span><span class=p>)</span>
</span><span id=__span-9-21><a id=__codelineno-9-21 name=__codelineno-9-21 href=#__codelineno-9-21></a>    <span class=k>return</span> <span class=n>Rate</span><span class=o>.</span><span class=n>parse</span><span class=p>(</span><span class=s2>&quot;300/min&quot;</span><span class=p>)</span>
</span><span id=__span-9-22><a id=__codelineno-9-22 name=__codelineno-9-22 href=#__codelineno-9-22></a>
</span><span id=__span-9-23><a id=__codelineno-9-23 name=__codelineno-9-23 href=#__codelineno-9-23></a>
</span><span id=__span-9-24><a id=__codelineno-9-24 name=__codelineno-9-24 href=#__codelineno-9-24></a><span class=c1># Carve-outs: global throttle should NOT apply to these</span>
</span><span id=__span-9-25><a id=__codelineno-9-25 name=__codelineno-9-25 href=#__codelineno-9-25></a><span class=n>bypass_GET_users</span> <span class=o>=</span> <span class=n>BypassThrottleRule</span><span class=p>(</span><span class=n>path</span><span class=o>=</span><span class=s2>&quot;/api/v1/users&quot;</span><span class=p>,</span> <span class=n>methods</span><span class=o>=</span><span class=p>{</span><span class=s2>&quot;GET&quot;</span><span class=p>})</span>
</span><span id=__span-9-26><a id=__codelineno-9-26 name=__codelineno-9-26 href=#__codelineno-9-26></a><span class=n>bypass_POST_orgs</span> <span class=o>=</span> <span class=n>BypassThrottleRule</span><span class=p>(</span><span class=n>path</span><span class=o>=</span><span class=s2>&quot;/api/v1/organizations&quot;</span><span class=p>,</span> <span class=n>methods</span><span class=o>=</span><span class=p>{</span><span class=s2>&quot;POST&quot;</span><span class=p>})</span>
</span><span id=__span-9-27><a id=__codelineno-9-27 name=__codelineno-9-27 href=#__codelineno-9-27></a>
</span><span id=__span-9-28><a id=__codelineno-9-28 name=__codelineno-9-28 href=#__codelineno-9-28></a><span class=n>global_throttle</span> <span class=o>=</span> <span class=n>HTTPThrottle</span><span class=p>(</span>
</span><span id=__span-9-29><a id=__codelineno-9-29 name=__codelineno-9-29 href=#__codelineno-9-29></a>    <span class=s2>&quot;api:v1&quot;</span><span class=p>,</span>
</span><span id=__span-9-30><a id=__codelineno-9-30 name=__codelineno-9-30 href=#__codelineno-9-30></a>    <span class=n>rate</span><span class=o>=</span><span class=n>global_rate</span><span class=p>,</span>
</span><span id=__span-9-31><a id=__codelineno-9-31 name=__codelineno-9-31 href=#__codelineno-9-31></a>    <span class=n>rules</span><span class=o>=</span><span class=p>{</span><span class=n>bypass_GET_users</span><span class=p>,</span> <span class=n>bypass_POST_orgs</span><span class=p>},</span>  <span class=c1># (1)!</span>
</span><span id=__span-9-32><a id=__codelineno-9-32 name=__codelineno-9-32 href=#__codelineno-9-32></a><span class=p>)</span>
</span><span id=__span-9-33><a id=__codelineno-9-33 name=__codelineno-9-33 href=#__codelineno-9-33></a><span class=n>main_router</span> <span class=o>=</span> <span class=n>APIRouter</span><span class=p>(</span><span class=n>prefix</span><span class=o>=</span><span class=s2>&quot;/api/v1&quot;</span><span class=p>,</span> <span class=n>dependencies</span><span class=o>=</span><span class=p>[</span><span class=n>Depends</span><span class=p>(</span><span class=n>global_throttle</span><span class=p>)])</span>
</span><span id=__span-9-34><a id=__codelineno-9-34 name=__codelineno-9-34 href=#__codelineno-9-34></a>
</span><span id=__span-9-35><a id=__codelineno-9-35 name=__codelineno-9-35 href=#__codelineno-9-35></a>
</span><span id=__span-9-36><a id=__codelineno-9-36 name=__codelineno-9-36 href=#__codelineno-9-36></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>get_user_id</span><span class=p>(</span><span class=n>connection</span><span class=p>:</span> <span class=n>Request</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span><span id=__span-9-37><a id=__codelineno-9-37 name=__codelineno-9-37 href=#__codelineno-9-37></a>    <span class=k>return</span> <span class=nb>getattr</span><span class=p>(</span><span class=n>connection</span><span class=o>.</span><span class=n>state</span><span class=p>,</span> <span class=s2>&quot;user_id&quot;</span><span class=p>,</span> <span class=s2>&quot;__anon__&quot;</span><span class=p>)</span>
</span><span id=__span-9-38><a id=__codelineno-9-38 name=__codelineno-9-38 href=#__codelineno-9-38></a>
</span><span id=__span-9-39><a id=__codelineno-9-39 name=__codelineno-9-39 href=#__codelineno-9-39></a>
</span><span id=__span-9-40><a id=__codelineno-9-40 name=__codelineno-9-40 href=#__codelineno-9-40></a><span class=c1># USERS ROUTER </span>
</span><span id=__span-9-41><a id=__codelineno-9-41 name=__codelineno-9-41 href=#__codelineno-9-41></a><span class=c1># GET: 500/min (per-user), POST: unlimited</span>
</span><span id=__span-9-42><a id=__codelineno-9-42 name=__codelineno-9-42 href=#__codelineno-9-42></a>
</span><span id=__span-9-43><a id=__codelineno-9-43 name=__codelineno-9-43 href=#__codelineno-9-43></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>user_rate</span><span class=p>(</span>
</span><span id=__span-9-44><a id=__codelineno-9-44 name=__codelineno-9-44 href=#__codelineno-9-44></a>    <span class=n>connection</span><span class=p>:</span> <span class=n>Request</span><span class=p>,</span>
</span><span id=__span-9-45><a id=__codelineno-9-45 name=__codelineno-9-45 href=#__codelineno-9-45></a>    <span class=n>context</span><span class=p>:</span> <span class=n>typing</span><span class=o>.</span><span class=n>Optional</span><span class=p>[</span><span class=n>typing</span><span class=o>.</span><span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>typing</span><span class=o>.</span><span class=n>Any</span><span class=p>]],</span>
</span><span id=__span-9-46><a id=__codelineno-9-46 name=__codelineno-9-46 href=#__codelineno-9-46></a><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Rate</span><span class=p>:</span>
</span><span id=__span-9-47><a id=__codelineno-9-47 name=__codelineno-9-47 href=#__codelineno-9-47></a>    <span class=k>if</span> <span class=n>connection</span><span class=o>.</span><span class=n>scope</span><span class=p>[</span><span class=s2>&quot;method&quot;</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&quot;GET&quot;</span><span class=p>:</span>
</span><span id=__span-9-48><a id=__codelineno-9-48 name=__codelineno-9-48 href=#__codelineno-9-48></a>        <span class=k>return</span> <span class=n>Rate</span><span class=o>.</span><span class=n>parse</span><span class=p>(</span><span class=s2>&quot;500/min&quot;</span><span class=p>)</span>
</span><span id=__span-9-49><a id=__codelineno-9-49 name=__codelineno-9-49 href=#__codelineno-9-49></a>    <span class=k>return</span> <span class=n>Rate</span><span class=p>()</span>  <span class=c1># Rate() with no args = unlimited = no throttling</span>
</span><span id=__span-9-50><a id=__codelineno-9-50 name=__codelineno-9-50 href=#__codelineno-9-50></a>
</span><span id=__span-9-51><a id=__codelineno-9-51 name=__codelineno-9-51 href=#__codelineno-9-51></a>
</span><span id=__span-9-52><a id=__codelineno-9-52 name=__codelineno-9-52 href=#__codelineno-9-52></a><span class=n>users_throttle</span> <span class=o>=</span> <span class=n>HTTPThrottle</span><span class=p>(</span>
</span><span id=__span-9-53><a id=__codelineno-9-53 name=__codelineno-9-53 href=#__codelineno-9-53></a>    <span class=s2>&quot;api:users&quot;</span><span class=p>,</span>
</span><span id=__span-9-54><a id=__codelineno-9-54 name=__codelineno-9-54 href=#__codelineno-9-54></a>    <span class=n>rate</span><span class=o>=</span><span class=n>user_rate</span><span class=p>,</span>
</span><span id=__span-9-55><a id=__codelineno-9-55 name=__codelineno-9-55 href=#__codelineno-9-55></a>    <span class=n>identifier</span><span class=o>=</span><span class=n>get_user_id</span><span class=p>,</span>  <span class=c1># Per-user tracking (2)!</span>
</span><span id=__span-9-56><a id=__codelineno-9-56 name=__codelineno-9-56 href=#__codelineno-9-56></a><span class=p>)</span>
</span><span id=__span-9-57><a id=__codelineno-9-57 name=__codelineno-9-57 href=#__codelineno-9-57></a><span class=n>users_router</span> <span class=o>=</span> <span class=n>APIRouter</span><span class=p>(</span><span class=n>prefix</span><span class=o>=</span><span class=s2>&quot;/users&quot;</span><span class=p>,</span> <span class=n>dependencies</span><span class=o>=</span><span class=p>[</span><span class=n>Depends</span><span class=p>(</span><span class=n>users_throttle</span><span class=p>)])</span>
</span><span id=__span-9-58><a id=__codelineno-9-58 name=__codelineno-9-58 href=#__codelineno-9-58></a>
</span><span id=__span-9-59><a id=__codelineno-9-59 name=__codelineno-9-59 href=#__codelineno-9-59></a>
</span><span id=__span-9-60><a id=__codelineno-9-60 name=__codelineno-9-60 href=#__codelineno-9-60></a><span class=c1># ORGANIZATIONS ROUTER</span>
</span><span id=__span-9-61><a id=__codelineno-9-61 name=__codelineno-9-61 href=#__codelineno-9-61></a><span class=c1># GET: unlimited, POST: 600/min (per-user)</span>
</span><span id=__span-9-62><a id=__codelineno-9-62 name=__codelineno-9-62 href=#__codelineno-9-62></a>
</span><span id=__span-9-63><a id=__codelineno-9-63 name=__codelineno-9-63 href=#__codelineno-9-63></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>orgs_rate</span><span class=p>(</span>
</span><span id=__span-9-64><a id=__codelineno-9-64 name=__codelineno-9-64 href=#__codelineno-9-64></a>    <span class=n>connection</span><span class=p>:</span> <span class=n>Request</span><span class=p>,</span>
</span><span id=__span-9-65><a id=__codelineno-9-65 name=__codelineno-9-65 href=#__codelineno-9-65></a>    <span class=n>context</span><span class=p>:</span> <span class=n>typing</span><span class=o>.</span><span class=n>Optional</span><span class=p>[</span><span class=n>typing</span><span class=o>.</span><span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>typing</span><span class=o>.</span><span class=n>Any</span><span class=p>]],</span>
</span><span id=__span-9-66><a id=__codelineno-9-66 name=__codelineno-9-66 href=#__codelineno-9-66></a><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Rate</span><span class=p>:</span>
</span><span id=__span-9-67><a id=__codelineno-9-67 name=__codelineno-9-67 href=#__codelineno-9-67></a>    <span class=k>if</span> <span class=n>connection</span><span class=o>.</span><span class=n>scope</span><span class=p>[</span><span class=s2>&quot;method&quot;</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&quot;POST&quot;</span><span class=p>:</span>
</span><span id=__span-9-68><a id=__codelineno-9-68 name=__codelineno-9-68 href=#__codelineno-9-68></a>        <span class=k>return</span> <span class=n>Rate</span><span class=o>.</span><span class=n>parse</span><span class=p>(</span><span class=s2>&quot;600/min&quot;</span><span class=p>)</span>
</span><span id=__span-9-69><a id=__codelineno-9-69 name=__codelineno-9-69 href=#__codelineno-9-69></a>    <span class=k>return</span> <span class=n>Rate</span><span class=p>()</span>  <span class=c1># Unlimited for GET</span>
</span><span id=__span-9-70><a id=__codelineno-9-70 name=__codelineno-9-70 href=#__codelineno-9-70></a>
</span><span id=__span-9-71><a id=__codelineno-9-71 name=__codelineno-9-71 href=#__codelineno-9-71></a>
</span><span id=__span-9-72><a id=__codelineno-9-72 name=__codelineno-9-72 href=#__codelineno-9-72></a><span class=n>orgs_throttle</span> <span class=o>=</span> <span class=n>HTTPThrottle</span><span class=p>(</span>
</span><span id=__span-9-73><a id=__codelineno-9-73 name=__codelineno-9-73 href=#__codelineno-9-73></a>    <span class=s2>&quot;api:orgs&quot;</span><span class=p>,</span>
</span><span id=__span-9-74><a id=__codelineno-9-74 name=__codelineno-9-74 href=#__codelineno-9-74></a>    <span class=n>rate</span><span class=o>=</span><span class=n>orgs_rate</span><span class=p>,</span>
</span><span id=__span-9-75><a id=__codelineno-9-75 name=__codelineno-9-75 href=#__codelineno-9-75></a>    <span class=n>identifier</span><span class=o>=</span><span class=n>get_user_id</span><span class=p>,</span>
</span><span id=__span-9-76><a id=__codelineno-9-76 name=__codelineno-9-76 href=#__codelineno-9-76></a><span class=p>)</span>
</span><span id=__span-9-77><a id=__codelineno-9-77 name=__codelineno-9-77 href=#__codelineno-9-77></a><span class=n>orgs_router</span> <span class=o>=</span> <span class=n>APIRouter</span><span class=p>(</span>
</span><span id=__span-9-78><a id=__codelineno-9-78 name=__codelineno-9-78 href=#__codelineno-9-78></a>    <span class=n>prefix</span><span class=o>=</span><span class=s2>&quot;/organizations&quot;</span><span class=p>,</span>
</span><span id=__span-9-79><a id=__codelineno-9-79 name=__codelineno-9-79 href=#__codelineno-9-79></a>    <span class=n>dependencies</span><span class=o>=</span><span class=p>[</span><span class=n>Depends</span><span class=p>(</span><span class=n>orgs_throttle</span><span class=p>)],</span>
</span><span id=__span-9-80><a id=__codelineno-9-80 name=__codelineno-9-80 href=#__codelineno-9-80></a><span class=p>)</span>
</span><span id=__span-9-81><a id=__codelineno-9-81 name=__codelineno-9-81 href=#__codelineno-9-81></a>
</span><span id=__span-9-82><a id=__codelineno-9-82 name=__codelineno-9-82 href=#__codelineno-9-82></a>
</span><span id=__span-9-83><a id=__codelineno-9-83 name=__codelineno-9-83 href=#__codelineno-9-83></a><span class=nd>@orgs_router</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=s2>&quot;/&quot;</span><span class=p>)</span>
</span><span id=__span-9-84><a id=__codelineno-9-84 name=__codelineno-9-84 href=#__codelineno-9-84></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>create_organization</span><span class=p>(</span><span class=n>data</span><span class=p>:</span> <span class=n>typing</span><span class=o>.</span><span class=n>Any</span><span class=p>):</span>
</span><span id=__span-9-85><a id=__codelineno-9-85 name=__codelineno-9-85 href=#__codelineno-9-85></a>    <span class=c1># Only orgs_throttle applies (POST; global is bypassed)</span>
</span><span id=__span-9-86><a id=__codelineno-9-86 name=__codelineno-9-86 href=#__codelineno-9-86></a>    <span class=k>pass</span>
</span><span id=__span-9-87><a id=__codelineno-9-87 name=__codelineno-9-87 href=#__codelineno-9-87></a>
</span><span id=__span-9-88><a id=__codelineno-9-88 name=__codelineno-9-88 href=#__codelineno-9-88></a>
</span><span id=__span-9-89><a id=__codelineno-9-89 name=__codelineno-9-89 href=#__codelineno-9-89></a><span class=nd>@orgs_router</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;/</span><span class=si>{org_id}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-9-90><a id=__codelineno-9-90 name=__codelineno-9-90 href=#__codelineno-9-90></a><span class=nd>@throttled</span><span class=p>(</span>
</span><span id=__span-9-91><a id=__codelineno-9-91 name=__codelineno-9-91 href=#__codelineno-9-91></a>    <span class=n>HTTPThrottle</span><span class=p>(</span><span class=s2>&quot;api:orgs:get&quot;</span><span class=p>,</span> <span class=n>rate</span><span class=o>=</span><span class=s2>&quot;100/min&quot;</span><span class=p>)</span>  <span class=c1># (3)!</span>
</span><span id=__span-9-92><a id=__codelineno-9-92 name=__codelineno-9-92 href=#__codelineno-9-92></a><span class=p>)</span>
</span><span id=__span-9-93><a id=__codelineno-9-93 name=__codelineno-9-93 href=#__codelineno-9-93></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>get_organization</span><span class=p>(</span><span class=n>org_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span><span id=__span-9-94><a id=__codelineno-9-94 name=__codelineno-9-94 href=#__codelineno-9-94></a>    <span class=c1># orgs_throttle + api:orgs:get throttle both apply here</span>
</span><span id=__span-9-95><a id=__codelineno-9-95 name=__codelineno-9-95 href=#__codelineno-9-95></a>    <span class=k>pass</span>
</span><span id=__span-9-96><a id=__codelineno-9-96 name=__codelineno-9-96 href=#__codelineno-9-96></a>
</span><span id=__span-9-97><a id=__codelineno-9-97 name=__codelineno-9-97 href=#__codelineno-9-97></a>
</span><span id=__span-9-98><a id=__codelineno-9-98 name=__codelineno-9-98 href=#__codelineno-9-98></a><span class=c1># ASSEMBLE THE APP</span>
</span><span id=__span-9-99><a id=__codelineno-9-99 name=__codelineno-9-99 href=#__codelineno-9-99></a><span class=n>main_router</span><span class=o>.</span><span class=n>include_router</span><span class=p>(</span><span class=n>users_router</span><span class=p>)</span>
</span><span id=__span-9-100><a id=__codelineno-9-100 name=__codelineno-9-100 href=#__codelineno-9-100></a><span class=n>main_router</span><span class=o>.</span><span class=n>include_router</span><span class=p>(</span><span class=n>orgs_router</span><span class=p>)</span>
</span><span id=__span-9-101><a id=__codelineno-9-101 name=__codelineno-9-101 href=#__codelineno-9-101></a><span class=n>app</span><span class=o>.</span><span class=n>include_router</span><span class=p>(</span><span class=n>main_router</span><span class=p>)</span>
</span></code></pre></div> <ol> <li>Rules are passed at construction here. Alternatively, you can call <code>users_throttle.add_rules("api:v1", bypass_GET_users)</code> after the fact, both approaches produce identical results.</li> <li>Without <code>identifier=get_user_id</code>, the throttle would use the remote IP address. Per-user throttling ensures authenticated users each get their own 500/min quota rather than sharing a per-IP pool.</li> <li>Using <code>@throttled(...)</code> stacks an additional throttle on top of the router-level <code>orgs_throttle</code>. Both run on <code>GET /{org_id}</code>. Use this for routes that need stricter limits than their parent router.</li> </ol> <h3 id=what-happens-on-each-route>What happens on each route<a class=headerlink href=#what-happens-on-each-route title="Permanent link">&para;</a></h3> <table> <thead> <tr> <th>Route</th> <th>Throttles that apply</th> </tr> </thead> <tbody> <tr> <td><code>GET /api/v1/users</code></td> <td><code>api:users</code> only (global bypassed)</td> </tr> <tr> <td><code>POST /api/v1/users</code></td> <td><code>api:v1</code> global (300/min) + <code>api:users</code> unlimited</td> </tr> <tr> <td><code>GET /api/v1/organizations</code></td> <td><code>api:v1</code> global (1000/min) + <code>api:orgs</code> unlimited</td> </tr> <tr> <td><code>POST /api/v1/organizations</code></td> <td><code>api:orgs</code> (600/min) only (global bypassed)</td> </tr> <tr> <td><code>GET /api/v1/organizations/{id}</code></td> <td><code>api:v1</code> global (1000/min) + <code>api:orgs</code> unlimited + <code>api:orgs:get</code> (100/min)</td> </tr> </tbody> </table> <hr> <h2 id=choosing-the-right-tool>Choosing the Right Tool<a class=headerlink href=#choosing-the-right-tool title="Permanent link">&para;</a></h2> <p>There are three ways to make a throttle apply differently to different connections. Here's when to reach for each:</p> <div class="tabbed-set tabbed-alternate" data-tabs=1:3><input checked=checked id=__tabbed_1_1 name=__tabbed_1 type=radio><input id=__tabbed_1_2 name=__tabbed_1 type=radio><input id=__tabbed_1_3 name=__tabbed_1 type=radio><div class=tabbed-labels><label for=__tabbed_1_1>Rules</label><label for=__tabbed_1_2>Dynamic Identifiers</label><label for=__tabbed_1_3>Predicate Rules</label></div> <div class=tabbed-content> <div class=tabbed-block> <p><strong>Best when:</strong> The condition is based on the path or HTTP method. Structural routing concerns.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-10-1><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a><span class=c1># Apply only to admin routes</span>
</span><span id=__span-10-2><a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a><span class=n>ThrottleRule</span><span class=p>(</span><span class=n>path</span><span class=o>=</span><span class=s2>&quot;/api/admin/**&quot;</span><span class=p>)</span>
</span><span id=__span-10-3><a id=__codelineno-10-3 name=__codelineno-10-3 href=#__codelineno-10-3></a>
</span><span id=__span-10-4><a id=__codelineno-10-4 name=__codelineno-10-4 href=#__codelineno-10-4></a><span class=c1># Skip for health checks</span>
</span><span id=__span-10-5><a id=__codelineno-10-5 name=__codelineno-10-5 href=#__codelineno-10-5></a><span class=n>BypassThrottleRule</span><span class=p>(</span><span class=n>path</span><span class=o>=</span><span class=s2>&quot;/health&quot;</span><span class=p>)</span>
</span></code></pre></div> <p>Rules are evaluated before any backend I/O. Zero quota is consumed when a rule skips a throttle. They're the cheapest way to make structural decisions.</p> </div> <div class=tabbed-block> <p><strong>Best when:</strong> You want the <em>same</em> throttle to track different groups of clients separately by returning different identifier strings.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-11-1><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>tier_identifier</span><span class=p>(</span><span class=n>connection</span><span class=p>:</span> <span class=n>Request</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span><span id=__span-11-2><a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a>    <span class=n>user</span> <span class=o>=</span> <span class=n>connection</span><span class=o>.</span><span class=n>state</span><span class=o>.</span><span class=n>user</span>
</span><span id=__span-11-3><a id=__codelineno-11-3 name=__codelineno-11-3 href=#__codelineno-11-3></a>    <span class=k>return</span> <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>user</span><span class=o>.</span><span class=n>tier</span><span class=si>}</span><span class=s2>:</span><span class=si>{</span><span class=n>user</span><span class=o>.</span><span class=n>id</span><span class=si>}</span><span class=s2>&quot;</span>
</span><span id=__span-11-4><a id=__codelineno-11-4 name=__codelineno-11-4 href=#__codelineno-11-4></a><span class=c1># premium:42 and free:42 get separate counters</span>
</span></code></pre></div> <p>Use this when the throttle logic is the same but you want per-group accounting, e.g., premium vs free tier users each get their own 1000/min pool.</p> </div> <div class=tabbed-block> <p><strong>Best when:</strong> The condition involves async logic or data not available from the path/method alone, like user tier, feature flags, or tenant config.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-12-1><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>only_external</span><span class=p>(</span><span class=n>connection</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span><span id=__span-12-2><a id=__codelineno-12-2 name=__codelineno-12-2 href=#__codelineno-12-2></a>    <span class=k>return</span> <span class=ow>not</span> <span class=nb>getattr</span><span class=p>(</span><span class=n>connection</span><span class=o>.</span><span class=n>state</span><span class=p>,</span> <span class=s2>&quot;is_internal&quot;</span><span class=p>,</span> <span class=kc>False</span><span class=p>)</span>
</span><span id=__span-12-3><a id=__codelineno-12-3 name=__codelineno-12-3 href=#__codelineno-12-3></a>
</span><span id=__span-12-4><a id=__codelineno-12-4 name=__codelineno-12-4 href=#__codelineno-12-4></a><span class=n>ThrottleRule</span><span class=p>(</span><span class=n>predicate</span><span class=o>=</span><span class=n>only_external</span><span class=p>)</span>
</span></code></pre></div> <p>Predicates run after path/method checks and involve an <code>await</code>. Use them for cross-cutting concerns that can't be expressed structurally.</p> </div> </div> </div> <div class="admonition tip"> <p class=admonition-title>Combine freely</p> <p>Rules, identifiers, and predicates compose. A single throttle can have multiple bypass rules (e.g., one for <code>/health</code>, one for internal IPs) <em>and</em> a custom identifier <em>and</em> a predicate, all working together. Traffik evaluates them in the correct order automatically.</p> </div> <hr> <h2 id=summary>Summary<a class=headerlink href=#summary title="Permanent link">&para;</a></h2> <table> <thead> <tr> <th>Concept</th> <th>What it does</th> </tr> </thead> <tbody> <tr> <td><code>ThrottleRule(path, methods, predicate)</code></td> <td>Apply throttle <strong>only</strong> when connection matches</td> </tr> <tr> <td><code>BypassThrottleRule(path, methods, predicate)</code></td> <td>Skip throttle <strong>when</strong> connection matches</td> </tr> <tr> <td><code>BypassThrottleRule</code> checked first</td> <td>Short-circuits before any <code>ThrottleRule</code> in the same tier</td> </tr> <tr> <td><code>rules={...}</code> in constructor</td> <td>Attach rules at throttle creation</td> </tr> <tr> <td><code>throttle.add_rules("uid", rule)</code></td> <td>Attach rules to another throttle by UID after creation</td> </tr> <tr> <td><code>*</code> in path pattern</td> <td>Matches one path segment (no <code>/</code>)</td> </tr> <tr> <td><code>**</code> in path pattern</td> <td>Matches multiple segments (including <code>/</code>)</td> </tr> <tr> <td>Plain string path</td> <td>Prefix regex match</td> </tr> <tr> <td><code>re.compile(...)</code> path</td> <td>Exact regex match</td> </tr> <tr> <td><code>ThrottleRegistry</code></td> <td>The class backing <code>GLOBAL_REGISTRY</code>; pass a custom instance via <code>registry=</code></td> </tr> <tr> <td><code>GLOBAL_REGISTRY.exist("uid")</code></td> <td>Check if a throttle UID is registered</td> </tr> <tr> <td><code>dynamic_rules=True</code></td> <td>Re-fetch registry rules on every request</td> </tr> </tbody> </table> <form class=md-feedback name=feedback hidden> <fieldset> <legend class=md-feedback__title> Was this page helpful? </legend> <div class=md-feedback__inner> <div class=md-feedback__list> <button class="md-feedback__icon md-icon" type=submit title="This page was helpful" data-md-value=1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m7 0c0 .8-.7 1.5-1.5 1.5S14 10.3 14 9.5 14.7 8 15.5 8s1.5.7 1.5 1.5m-5 7.73c-1.75 0-3.29-.73-4.19-1.81L9.23 14c.45.72 1.52 1.23 2.77 1.23s2.32-.51 2.77-1.23l1.42 1.42c-.9 1.08-2.44 1.81-4.19 1.81"/></svg> </button> <button class="md-feedback__icon md-icon" type=submit title="This page could be improved" data-md-value=0> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10m-6.5-4c.8 0 1.5.7 1.5 1.5s-.7 1.5-1.5 1.5-1.5-.7-1.5-1.5.7-1.5 1.5-1.5M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m2 4.5c1.75 0 3.29.72 4.19 1.81l-1.42 1.42C14.32 16.5 13.25 16 12 16s-2.32.5-2.77 1.23l-1.42-1.42C8.71 14.72 10.25 14 12 14"/></svg> </button> </div> <div class=md-feedback__note> <div data-md-value=1 hidden> Thanks for your feedback! </div> <div data-md-value=0 hidden> Thanks for your feedback! Help us improve by <a href=https://github.com/ti-oluwa/traffik/issues/new target=_blank rel=noopener>opening an issue</a>. </div> </div> </div> </fieldset> </form> </article> </div> <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top </button> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../headers/ class="md-footer__link md-footer__link--prev" aria-label="Previous: Response Headers"> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </div> <div class=md-footer__title> <span class=md-footer__direction> Previous </span> <div class=md-ellipsis> Response Headers </div> </div> </a> <a href=../registry/ class="md-footer__link md-footer__link--next" aria-label="Next: Throttle Registry"> <div class=md-footer__title> <span class=md-footer__direction> Next </span> <div class=md-ellipsis> Throttle Registry </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2026 tioluwa </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://github.com/ti-oluwa/traffik target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> <a href=https://pypi.org/project/traffik/ target=_blank rel=noopener title=pypi.org class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.8 200.5c-7.7-30.9-22.3-54.2-53.4-54.2h-40.1v47.4c0 36.8-31.2 67.8-66.8 67.8H172.7c-29.2 0-53.4 25-53.4 54.3v101.8c0 29 25.2 46 53.4 54.3 33.8 9.9 66.3 11.7 106.8 0 26.9-7.8 53.4-23.5 53.4-54.3v-40.7H226.2v-13.6h160.2c31.1 0 42.6-21.7 53.4-54.2 11.2-33.5 10.7-65.7 0-108.6M286.2 444.7a20.4 20.4 0 1 1 0-40.7 20.4 20.4 0 1 1 0 40.7M167.8 248.1h106.8c29.7 0 53.4-24.5 53.4-54.3V91.9c0-29-24.4-50.7-53.4-55.6-35.8-5.9-74.7-5.6-106.8.1-45.2 8-53.4 24.7-53.4 55.6v40.7h106.9v13.6h-147c-31.1 0-58.3 18.7-66.8 54.2-9.8 40.7-10.2 66.1 0 108.6 7.6 31.6 25.7 54.2 56.8 54.2H101v-48.8c0-35.3 30.5-66.4 66.8-66.4m-6.6-183.4a20.4 20.4 0 1 1 0 40.8 20.4 20.4 0 1 1 0-40.8"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"annotate": null, "base": "../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.expand", "navigation.path", "navigation.top", "navigation.footer", "search.suggest", "search.highlight", "search.share", "content.code.copy", "content.code.annotate", "content.tabs.link", "content.tooltips", "toc.follow"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script> <script src=../../assets/javascripts/bundle.79ae519e.min.js></script> </body> </html>